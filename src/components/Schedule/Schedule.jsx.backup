// Schedule Management Component
import React, { useState, useEffect } from 'react';
import './Schedule.css';
import scheduleService from '../../services/scheduleService';
import trainersService from '../../services/trainersService';
import { useAuth } from '../../contexts/AuthContext';

const Schedule = () => {
  const { currentUser } = useAuth();
  const [schedule, setSchedule] = useState({});
  const [trainers, setTrainers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [notification, setNotification] = useState(null);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showRecurringModal, setShowRecurringModal] = useState(false);
  const [editingLesson, setEditingLesson] = useState(null);
  const [currentWeek, setCurrentWeek] = useState(new Date());

  const [lessonForm, setLessonForm] = useState({
    title: '',
    type: '',
    trainerId: '',
    trainerName: '',
    dayOfWeek: 'monday',
    startTime: '',
    endTime: '',
    duration: 60,
    maxParticipants: 12,
    currentParticipants: 0,
    description: '',
    level: 'beginner',
    price: 0,
    scheduledDate: null
  });

  const [recurringForm, setRecurringForm] = useState({
    title: '',
    type: '',
    trainerId: '',
    trainerName: '',
    selectedDays: [],
    startTime: '',
    endTime: '',
    duration: 60,
    maxParticipants: 12,
    currentParticipants: 0,
    description: '',
    level: 'beginner',
    startDate: '',
    endDate: '',
    repeatWeeks: 4
  });

  const daysOfWeek = {
    monday: 'Pazartesi',
    tuesday: 'SalÄ±',
    wednesday: 'Ã‡arÅŸamba',
    thursday: 'PerÅŸembe',
    friday: 'Cuma',
    saturday: 'Cumartesi',
    sunday: 'Pazar'
  };



  const lessonTypes = [
    'Pilates',
    'Yoga',
    'Reformer',
    'Mat Pilates',
    'Yoga Flow',
    'Yin Yoga',
    'Vinyasa',
    'Hatha Yoga',
    'Strength Training',
    'Cardio',
    'Stretching',
    'Meditation'
  ];

  const levels = {
    beginner: 'BaÅŸlangÄ±Ã§',
    intermediate: 'Orta',
    advanced: 'Ä°leri',
    all: 'TÃ¼m Seviyeler'
  };

  // Generate time slots from 06:00 to 22:00 in 30-minute intervals
  const generateTimeSlots = () => {
    const slots = [];
    for (let hour = 6; hour <= 22; hour++) {
      for (let minute = 0; minute < 60; minute += 30) {
        const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        slots.push(timeString);
      }
    }
    return slots;
  };

  // Generate date options for the next 60 days
  const generateDateOptions = () => {
    const dates = [];
    const today = new Date();
    
    for (let i = 0; i < 60; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      
      const dateString = date.toISOString().split('T')[0];
      const displayDate = date.toLocaleDateString('tr-TR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      dates.push({
        value: dateString,
        label: displayDate
      });
    }
    
    return dates;
  };

  const timeSlots = generateTimeSlots();
  const dateOptions = generateDateOptions();

  // Get week dates
  const getWeekDates = (date) => {
    const week = [];
    const startOfWeek = new Date(date);
    const dayOfWeek = startOfWeek.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    startOfWeek.setDate(startOfWeek.getDate() + mondayOffset);

    for (let i = 0; i < 7; i++) {
      const day = new Date(startOfWeek);
      day.setDate(startOfWeek.getDate() + i);
      week.push(day);
    }
    return week;
  };

  const weekDates = getWeekDates(currentWeek);

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {
        // Add a simple check for Firebase configuration
        console.log('ğŸ”§ Firebase config check:', {
          projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
          apiKey: import.meta.env.VITE_FIREBASE_API_KEY ? 'present' : 'missing'
        });
        
        if (!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') {
          console.warn('âš ï¸ Firebase not configured properly, using demo data');
          // Use demo data when Firebase is not configured
          setSchedule({
            monday: [
              {
                id: 'demo1',
                title: 'Sabah Yoga',
                type: 'Yoga',
                trainerId: 'demo-trainer',
                trainerName: 'Demo EÄŸitmen',
                dayOfWeek: 'monday',
                startTime: '09:00',
                endTime: '10:00',
                duration: 60,
                maxParticipants: 15,
                level: 'beginner'
              }
            ],
            tuesday: [
              {
                id: 'demo2',
                title: 'Pilates',
                type: 'Pilates',
                trainerId: 'demo-trainer',
                trainerName: 'Demo EÄŸitmen',
                dayOfWeek: 'tuesday',
                startTime: '10:00',
                endTime: '11:00',
                duration: 60,
                maxParticipants: 12,
                level: 'intermediate'
              }
            ],
            wednesday: [],
            thursday: [],
            friday: [],
            saturday: [],
            sunday: []
          });
          setTrainers([
            {
              id: 'demo-trainer',
              displayName: 'Demo EÄŸitmen',
              firstName: 'Demo',
              lastName: 'EÄŸitmen'
            }
          ]);
          setLoading(false);
          return;
        }

        // Calculate week date range for filtering
        const currentWeekDates = getWeekDates(currentWeek);
        const weekStart = new Date(currentWeekDates[0]);
        const weekEnd = new Date(currentWeekDates[6]);
        
        console.log('ğŸ“… Current week calculation:', {
          currentWeek: currentWeek.toDateString(),
          currentWeekDates: currentWeekDates.map(d => d.toDateString()),
          weekStart: weekStart.toDateString(),
          weekEnd: weekEnd.toDateString(),
          weekStartISO: weekStart.toISOString().split('T')[0],
          weekEndISO: weekEnd.toISOString().split('T')[0]
        });

        const [scheduleResult, trainersResult] = await Promise.all([
          scheduleService.getWeeklyScheduleByDateRange(weekStart, weekEnd),
          trainersService.getAllTrainers()
        ]);

        console.log('Schedule result:', scheduleResult);
        console.log('Trainers result:', trainersResult);

        if (scheduleResult.success) {
          console.log('ğŸ“… Schedule data received:', scheduleResult.schedule);
          setSchedule(scheduleResult.schedule || {
            monday: [], tuesday: [], wednesday: [], thursday: [], 
            friday: [], saturday: [], sunday: []
          });
        } else {
          console.warn('Schedule loading failed, using empty schedule');
          setSchedule({
            monday: [], tuesday: [], wednesday: [], thursday: [], 
            friday: [], saturday: [], sunday: []
          });
          if (scheduleResult.error) {
            showNotification('Program yÃ¼klenirken hata oluÅŸtu: ' + scheduleResult.error, 'error');
          }
        }

        if (trainersResult.success) {
          setTrainers(trainersResult.trainers || []);
          if (trainersResult.warning) {
            showNotification(trainersResult.warning, 'warning');
          }
        } else {
          console.warn('Trainers loading failed, using empty array');
          setTrainers([]);
        }
      } catch (error) {
        console.error('Error loading schedule data:', error);
        showNotification('Veri yÃ¼klenirken beklenmeyen bir hata oluÅŸtu.', 'error');
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, [currentWeek]);

  const loadScheduleData = async () => {
    setLoading(true);
    try {
      // Check for Firebase configuration
      console.log('ğŸ”§ Firebase config check (refresh):', {
        projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
        apiKey: import.meta.env.VITE_FIREBASE_API_KEY ? 'present' : 'missing'
      });
      
      if (!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') {
        console.warn('âš ï¸ Firebase not configured properly, using demo data');
        // Use demo data when Firebase is not configured
        setSchedule({
          monday: [
            {
              id: 'demo1',
              title: 'Sabah Yoga',
              type: 'Yoga',
              trainerId: 'demo-trainer-1',
              trainerName: 'AyÅŸe YÄ±lmaz',
              dayOfWeek: 'monday',
              startTime: '09:00',
              endTime: '10:00',
              duration: 60,
              maxParticipants: 15,
              level: 'beginner'
            },
            {
              id: 'demo2',
              title: 'Reformer Pilates',
              type: 'Reformer',
              trainerId: 'demo-trainer-2',
              trainerName: 'Mehmet Demir',
              dayOfWeek: 'monday',
              startTime: '18:00',
              endTime: '19:00',
              duration: 60,
              maxParticipants: 8,
              level: 'intermediate'
            }
          ],
          tuesday: [
            {
              id: 'demo3',
              title: 'Mat Pilates',
              type: 'Mat Pilates',
              trainerId: 'demo-trainer-1',
              trainerName: 'AyÅŸe YÄ±lmaz',
              dayOfWeek: 'tuesday',
              startTime: '10:00',
              endTime: '11:00',
              duration: 60,
              maxParticipants: 12,
              level: 'beginner'
            },
            {
              id: 'demo4',
              title: 'Vinyasa Flow',
              type: 'Vinyasa',
              trainerId: 'demo-trainer-3',
              trainerName: 'Zeynep Kaya',
              dayOfWeek: 'tuesday',
              startTime: '19:00',
              endTime: '20:30',
              duration: 90,
              maxParticipants: 15,
              level: 'advanced'
            }
          ],
          wednesday: [
            {
              id: 'demo5',
              title: 'Yin Yoga',
              type: 'Yin Yoga',
              trainerId: 'demo-trainer-3',
              trainerName: 'Zeynep Kaya',
              dayOfWeek: 'wednesday',
              startTime: '11:00',
              endTime: '12:00',
              duration: 60,
              maxParticipants: 10,
              level: 'all'
            }
          ],
          thursday: [
            {
              id: 'demo6',
              title: 'Strength Training',
              type: 'Strength Training',
              trainerId: 'demo-trainer-2',
              trainerName: 'Mehmet Demir',
              dayOfWeek: 'thursday',
              startTime: '17:00',
              endTime: '18:00',
              duration: 60,
              maxParticipants: 10,
              level: 'intermediate'
            }
          ],
          friday: [
            {
              id: 'demo7',
              title: 'Pilates',
              type: 'Pilates',
              trainerId: 'demo-trainer-1',
              trainerName: 'AyÅŸe YÄ±lmaz',
              dayOfWeek: 'friday',
              startTime: '09:30',
              endTime: '10:30',
              duration: 60,
              maxParticipants: 12,
              level: 'intermediate'
            }
          ],
          saturday: [
            {
              id: 'demo8',
              title: 'Meditation',
              type: 'Meditation',
              trainerId: 'demo-trainer-3',
              trainerName: 'Zeynep Kaya',
              dayOfWeek: 'saturday',
              startTime: '10:00',
              endTime: '10:45',
              duration: 45,
              maxParticipants: 20,
              level: 'all'
            }
          ],
          sunday: []
        });
        setTrainers([
          {
            id: 'demo-trainer-1',
            displayName: 'AyÅŸe YÄ±lmaz',
            firstName: 'AyÅŸe',
            lastName: 'YÄ±lmaz'
          },
          {
            id: 'demo-trainer-2',
            displayName: 'Mehmet Demir',
            firstName: 'Mehmet',
            lastName: 'Demir'
          },
          {
            id: 'demo-trainer-3',
            displayName: 'Zeynep Kaya',
            firstName: 'Zeynep',
            lastName: 'Kaya'
          }
        ]);
        setLoading(false);
        return;
      }

        // Calculate week date range for filtering
        const currentWeekDates = getWeekDates(currentWeek);
        const weekStart = new Date(currentWeekDates[0]);
        const weekEnd = new Date(currentWeekDates[6]);
        
        console.log('ğŸ”„ Refresh - Current week calculation:', {
          currentWeek: currentWeek.toDateString(),
          currentWeekDates: currentWeekDates.map(d => d.toDateString()),
          weekStart: weekStart.toDateString(),
          weekEnd: weekEnd.toDateString(),
          weekStartISO: weekStart.toISOString().split('T')[0],
          weekEndISO: weekEnd.toISOString().split('T')[0]
        });

      const [scheduleResult, trainersResult] = await Promise.all([
        scheduleService.getWeeklyScheduleByDateRange(weekStart, weekEnd),
        trainersService.getAllTrainers()
      ]);

      console.log('Refresh - Schedule result:', scheduleResult);
      console.log('Refresh - Trainers result:', trainersResult);

      if (scheduleResult.success) {
        console.log('ğŸ”„ Schedule refresh data received:', scheduleResult.schedule);
        
        // Log each day's lessons for debugging
        Object.keys(scheduleResult.schedule).forEach(day => {
          const dayLessons = scheduleResult.schedule[day] || [];
          console.log(`ğŸ“… ${day}: ${dayLessons.length} lessons`, dayLessons.map(l => ({
            id: l.id,
            title: l.title,
            dayOfWeek: l.dayOfWeek,
            startTime: l.startTime
          })));
        });
        
        setSchedule(scheduleResult.schedule || {
          monday: [], tuesday: [], wednesday: [], thursday: [], 
          friday: [], saturday: [], sunday: []
        });
      } else {
        console.warn('Schedule refresh failed, keeping current state');
        if (scheduleResult.error) {
          showNotification('Program yÃ¼klenirken hata oluÅŸtu: ' + scheduleResult.error, 'error');
        }
      }

      if (trainersResult.success) {
        setTrainers(trainersResult.trainers || []);
        if (trainersResult.warning) {
          showNotification(trainersResult.warning, 'warning');
        }
      } else {
        console.warn('Trainers refresh failed, keeping current state');
      }
    } catch (error) {
      console.error('Error loading schedule data:', error);
      showNotification('Veri yÃ¼klenirken beklenmeyen bir hata oluÅŸtu.', 'error');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateLesson = (dayOfWeek, timeSlot) => {
    setEditingLesson(null);
    
    // Calculate the specific date for this lesson
    const dayIndex = Object.keys(daysOfWeek).indexOf(dayOfWeek);
    const specificDate = weekDates[dayIndex];
    const scheduledDate = specificDate.toISOString();
    
    console.log('ğŸ“… Creating lesson for specific date:', {
      dayOfWeek,
      dayIndex,
      specificDate: specificDate.toDateString(),
      scheduledDate
    });
    
    setLessonForm({
      title: '',
      type: '',
      trainerId: currentUser?.role === 'instructor' ? currentUser.uid : '',
      trainerName: currentUser?.role === 'instructor' ? currentUser.displayName : '',
      dayOfWeek: dayOfWeek,
      startTime: timeSlot,
      endTime: '',
      duration: 60,
      maxParticipants: 12,
      currentParticipants: 0,
      description: '',
      level: 'beginner',
      price: 0,
      scheduledDate: scheduledDate
    });
    setShowCreateModal(true);
  };

  const handleEditLesson = (lesson) => {
    console.log('ğŸ“ Starting to edit lesson:', {
      id: lesson.id,
      title: lesson.title,
      dayOfWeek: lesson.dayOfWeek,
      startTime: lesson.startTime,
      endTime: lesson.endTime,
      duration: lesson.duration,
      trainerId: lesson.trainerId
    });
    
    setEditingLesson(lesson);
    setLessonForm({
      title: lesson.title || '',
      type: lesson.type || '',
      trainerId: lesson.trainerId || '',
      trainerName: lesson.trainerName || '',
      dayOfWeek: lesson.dayOfWeek || 'monday',
      startTime: lesson.startTime || '',
      endTime: lesson.endTime || '',
      duration: lesson.duration || 60,
      maxParticipants: lesson.maxParticipants || 12,
      currentParticipants: lesson.currentParticipants || 0,
      description: lesson.description || '',
      level: lesson.level || 'beginner',
      price: lesson.price || 0,
      scheduledDate: lesson.scheduledDate || null
    });
    setShowCreateModal(true);
  };

  const handleFormChange = (field, value) => {
    setLessonForm(prev => {
      const updated = { ...prev, [field]: value };
      
      // Auto-calculate end time when start time or duration changes
      if (field === 'startTime' || field === 'duration') {
        if (updated.startTime && updated.duration) {
          const [hours, minutes] = updated.startTime.split(':').map(Number);
          const startMinutes = hours * 60 + minutes;
          const endMinutes = startMinutes + parseInt(updated.duration);
          const endHours = Math.floor(endMinutes / 60);
          const endMins = endMinutes % 60;
          updated.endTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }
      }
      
      // Auto-calculate duration when end time changes
      if (field === 'endTime' && updated.startTime && updated.endTime) {
        const [startHours, startMinutes] = updated.startTime.split(':').map(Number);
        const [endHours, endMinutes] = updated.endTime.split(':').map(Number);
        const startTotalMinutes = startHours * 60 + startMinutes;
        const endTotalMinutes = endHours * 60 + endMinutes;
        if (endTotalMinutes > startTotalMinutes) {
          updated.duration = endTotalMinutes - startTotalMinutes;
        }
      }

      if (field === 'trainerId') {
        const selectedTrainer = trainers.find(t => t.id === value);
        updated.trainerName = selectedTrainer ? selectedTrainer.displayName : '';
      }

      return updated;
    });
  };

  const handleRecurringFormChange = (field, value) => {
    setRecurringForm(prev => {
      const updated = { ...prev, [field]: value };
      
      // Auto-calculate end time when start time or duration changes
      if (field === 'startTime' || field === 'duration') {
        if (updated.startTime && updated.duration) {
          const [hours, minutes] = updated.startTime.split(':').map(Number);
          const startMinutes = hours * 60 + minutes;
          const endMinutes = startMinutes + parseInt(updated.duration);
          const endHours = Math.floor(endMinutes / 60);
          const endMins = endMinutes % 60;
          updated.endTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }
      }
      
      // Auto-calculate end date when start date or repeat weeks changes
      if (field === 'startDate' || field === 'repeatWeeks') {
        if (updated.startDate && updated.repeatWeeks) {
          const startDate = new Date(updated.startDate);
          const endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + (updated.repeatWeeks * 7) - 1);
          updated.endDate = endDate.toISOString().split('T')[0];
        }
      }

      if (field === 'trainerId') {
        const selectedTrainer = trainers.find(t => t.id === value);
        updated.trainerName = selectedTrainer ? selectedTrainer.displayName : '';
      }

      // Handle day selection
      if (field === 'selectedDays') {
        updated.selectedDays = value;
      }

      return updated;
    });
  };

  const handleDayToggle = (day) => {
    setRecurringForm(prev => ({
      ...prev,
      selectedDays: prev.selectedDays.includes(day)
        ? prev.selectedDays.filter(d => d !== day)
        : [...prev.selectedDays, day]
    }));
  };

  const generateRecurringLessons = () => {
    const lessons = [];
    const startDate = new Date(recurringForm.startDate);
    const weeksToGenerate = recurringForm.repeatWeeks || 4;
    
    console.log('ğŸ”„ Generating recurring lessons:', {
      startDate: startDate.toDateString(),
      selectedDays: recurringForm.selectedDays,
      weeksToGenerate
    });
    
    // For each week
    for (let week = 0; week < weeksToGenerate; week++) {
      // For each selected day of the week
      for (const dayOfWeek of recurringForm.selectedDays) {
        // Calculate the date for this specific day and week
        const dayIndex = Object.keys(daysOfWeek).indexOf(dayOfWeek); // 0=Monday, 1=Tuesday, etc.
        
        // Find Monday of the start week
        const startWeekDay = startDate.getDay(); // 0=Sunday, 1=Monday, etc.
        
        // Get the Monday of the week that contains the start date
        const mondayOfStartWeek = new Date(startDate);
        if (startWeekDay === 0) { // Sunday
          mondayOfStartWeek.setDate(startDate.getDate() + 1); // Next day is Monday
        } else if (startWeekDay === 1) { // Monday
          // Already Monday, no change needed
        } else {
          // Tuesday to Saturday - go back to Monday
          mondayOfStartWeek.setDate(startDate.getDate() - (startWeekDay - 1));
        }
        
        // Calculate the exact date for this lesson
        const lessonDate = new Date(mondayOfStartWeek);
        lessonDate.setDate(mondayOfStartWeek.getDate() + (week * 7) + dayIndex);
        
        console.log('ğŸ“… Calculated lesson date:', {
          week,
          dayOfWeek,
          dayIndex,
          startDate: startDate.toDateString(),
          startWeekDay,
          mondayOfStartWeek: mondayOfStartWeek.toDateString(),
          lessonDate: lessonDate.toDateString(),
          lessonDateISO: lessonDate.toISOString()
        });
        
        // Create lesson data
        const lessonData = {
          title: recurringForm.title,
          type: recurringForm.type,
          trainerId: recurringForm.trainerId,
          trainerName: recurringForm.trainerName,
          dayOfWeek: dayOfWeek,
          startTime: recurringForm.startTime,
          endTime: recurringForm.endTime,
          duration: recurringForm.duration,
          maxParticipants: recurringForm.maxParticipants,
          currentParticipants: recurringForm.currentParticipants,
          description: recurringForm.description,
          level: recurringForm.level,
          scheduledDate: lessonDate.toISOString(),
          isRecurring: true,
          recurringSeriesId: `series_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          weekNumber: week + 1,
          totalWeeks: weeksToGenerate
        };
        lessons.push(lessonData);
      }
    }
    
    console.log('âœ… Generated lessons:', lessons.length);
    return lessons;
  };

  const handleOpenRecurringModal = () => {
    const today = new Date();
    const endDateCalc = new Date(today);
    endDateCalc.setDate(today.getDate() + (4 * 7) - 1); // 4 weeks minus 1 day
    
    setRecurringForm({
      title: '',
      type: '',
      trainerId: currentUser?.role === 'instructor' ? currentUser.uid : '',
      trainerName: currentUser?.role === 'instructor' ? currentUser.displayName : '',
      selectedDays: [],
      startTime: '',
      endTime: '',
      duration: 60,
      maxParticipants: 12,
      currentParticipants: 0,
      description: '',
      level: 'beginner',
      startDate: today.toISOString().split('T')[0],
      endDate: endDateCalc.toISOString().split('T')[0],
      repeatWeeks: 4
    });
    setShowRecurringModal(true);
  };

  const handleSaveRecurringLessons = async () => {
    try {
      // Check if Firebase is configured
      if (!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') {
        showNotification('Demo modunda ders dÃ¼zenleme Ã¶zelliÄŸi kullanÄ±lamaz. Firebase yapÄ±landÄ±rmasÄ± gerekli.', 'info');
        setShowRecurringModal(false);
        return;
      }

      if (!recurringForm.title || !recurringForm.type || !recurringForm.trainerId || 
          !recurringForm.startTime || !recurringForm.endTime || recurringForm.selectedDays.length === 0) {
        showNotification('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun ve en az bir gÃ¼n seÃ§in.', 'error');
        return;
      }

      if (!recurringForm.startDate) {
        showNotification('LÃ¼tfen baÅŸlangÄ±Ã§ tarihini seÃ§in.', 'error');
        return;
      }

      const lessonsToCreate = generateRecurringLessons();
      
      console.log('ğŸ“… Lessons to create:', lessonsToCreate.length);
      console.log('ğŸ“‹ Selected days:', recurringForm.selectedDays);
      console.log('ğŸ”¢ Weeks to repeat:', recurringForm.repeatWeeks);
      console.log('ğŸ“† Start date:', recurringForm.startDate);
      console.log('ğŸ“† End date:', recurringForm.endDate);
      
      if (lessonsToCreate.length === 0) {
        showNotification('Belirtilen ayarlarda oluÅŸturulacak ders bulunamadÄ±.', 'error');
        return;
      }

      // Show confirmation to user
      const totalLessons = lessonsToCreate.length;
      const daysCount = recurringForm.selectedDays.length;
      const weeksCount = recurringForm.repeatWeeks;
      
      if (!window.confirm(
        `${totalLessons} ders oluÅŸturulacak (${daysCount} gÃ¼n Ã— ${weeksCount} hafta = ${totalLessons} ders).\n\nDevam etmek istiyor musunuz?`
      )) {
        return;
      }

      // Create all lessons using bulk creation
      const bulkResult = await scheduleService.createBulkLessons(lessonsToCreate);
      
      if (bulkResult.success) {
        const { successCount, failCount } = bulkResult;
        if (successCount > 0) {
          showNotification(
            `${successCount} ders baÅŸarÄ±yla oluÅŸturuldu${failCount > 0 ? `, ${failCount} ders oluÅŸturulamadÄ±` : ''}.`, 
            failCount > 0 ? 'warning' : 'success'
          );
          setShowRecurringModal(false);
          loadScheduleData();
        } else {
          showNotification('HiÃ§bir ders oluÅŸturulamadÄ±. LÃ¼tfen tekrar deneyin.', 'error');
        }
      } else {
        showNotification('Toplu ders oluÅŸturma iÅŸlemi baÅŸarÄ±sÄ±z oldu.', 'error');
      }
    } catch (error) {
      console.error('Error creating recurring lessons:', error);
      showNotification('Beklenmeyen bir hata oluÅŸtu.', 'error');
    }
  };

  const handleSaveLesson = async () => {
    try {
      // Check if Firebase is configured
      if (!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') {
        showNotification('Demo modunda ders dÃ¼zenleme Ã¶zelliÄŸi kullanÄ±lamaz. Firebase yapÄ±landÄ±rmasÄ± gerekli.', 'info');
        setShowCreateModal(false);
        return;
      }

      if (!lessonForm.title || !lessonForm.type || !lessonForm.trainerId || 
          !lessonForm.startTime || !lessonForm.endTime) {
        showNotification('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.', 'error');
        return;
      }

      // Only check for conflicts if we're changing time-related fields or trainer
      let shouldCheckConflict = false;
      
      if (editingLesson) {
        // For editing: check conflict only if time, day, or trainer changed
        const timeChanged = (
          lessonForm.startTime !== editingLesson.startTime ||
          lessonForm.endTime !== editingLesson.endTime ||
          lessonForm.duration !== editingLesson.duration
        );
        
        const dayChanged = lessonForm.dayOfWeek !== editingLesson.dayOfWeek;
        const trainerChanged = lessonForm.trainerId !== editingLesson.trainerId;
        
        // Special case: if only extending duration (same start time, later end time, same day, same trainer)
        const isOnlyExtending = (
          lessonForm.startTime === editingLesson.startTime &&
          lessonForm.endTime > editingLesson.endTime &&
          lessonForm.dayOfWeek === editingLesson.dayOfWeek &&
          lessonForm.trainerId === editingLesson.trainerId
        );
        
        shouldCheckConflict = timeChanged || dayChanged || trainerChanged;
        
        console.log('ğŸ” Edit conflict check decision:', {
          timeChanged,
          dayChanged,
          trainerChanged,
          isOnlyExtending,
          shouldCheckConflict,
          oldTime: `${editingLesson.startTime}-${editingLesson.endTime}`,
          newTime: `${lessonForm.startTime}-${lessonForm.endTime}`,
          oldDay: editingLesson.dayOfWeek,
          newDay: lessonForm.dayOfWeek,
          oldTrainer: editingLesson.trainerId,
          newTrainer: lessonForm.trainerId
        });
        
        // If we're only extending, use special conflict check logic
        if (isOnlyExtending) {
          console.log('ğŸ” This is a duration extension only - using extended conflict check');
        }
      } else {
        // For new lessons: always check conflict
        shouldCheckConflict = true;
        console.log('ğŸ” New lesson - checking conflict');
      }

      if (shouldCheckConflict) {
        console.log('ğŸ” Checking for time conflicts...');
        console.log('ğŸ” Conflict check parameters:', {
          trainerId: lessonForm.trainerId,
          dayOfWeek: lessonForm.dayOfWeek,
          startTime: lessonForm.startTime,
          endTime: lessonForm.endTime,
          excludeLessonId: editingLesson?.id,
          editingLessonExists: !!editingLesson,
          editingLessonData: editingLesson ? {
            id: editingLesson.id,
            title: editingLesson.title,
            startTime: editingLesson.startTime,
            endTime: editingLesson.endTime
          } : null
        });
        
        let conflictCheck;
        
        // Special case: if only extending duration, use the extension conflict check
        if (editingLesson && 
            lessonForm.startTime === editingLesson.startTime &&
            lessonForm.endTime > editingLesson.endTime &&
            lessonForm.dayOfWeek === editingLesson.dayOfWeek &&
            lessonForm.trainerId === editingLesson.trainerId) {
          
          console.log('ğŸ” Using extension-specific conflict check');
          conflictCheck = await scheduleService.checkLessonExtensionConflict(
            editingLesson.id,
            lessonForm.endTime
          );
        } else {
          console.log('ğŸ” Using regular conflict check');
          conflictCheck = await scheduleService.checkTimeConflict(
            lessonForm.trainerId,
            lessonForm.dayOfWeek,
            lessonForm.startTime,
            lessonForm.endTime,
            editingLesson?.id
          );
        }

        if (!conflictCheck.success) {
          showNotification(conflictCheck.error, 'error');
          return;
        }
      } else {
        console.log('â„¹ï¸ Skipping conflict check - only non-time fields changed');
      }

      let result;
      if (editingLesson) {
        console.log('ğŸ“ Updating lesson:', editingLesson.id);
        result = await scheduleService.updateLesson(editingLesson.id, lessonForm);
      } else {
        console.log('â• Creating new lesson');
        const lessonData = { ...lessonForm };
        result = await scheduleService.createLesson(lessonData);
      }

      if (result.success) {
        showNotification(
          editingLesson ? 'Ders baÅŸarÄ±yla gÃ¼ncellendi.' : 'Ders baÅŸarÄ±yla oluÅŸturuldu.',
          'success'
        );
        setShowCreateModal(false);
        loadScheduleData();
      } else {
        showNotification(result.error, 'error');
      }
    } catch (error) {
      console.error('Error saving lesson:', error);
      showNotification('Beklenmeyen bir hata oluÅŸtu.', 'error');
    }
  };

  const handleDeleteLesson = async (lessonId) => {
    // Check if Firebase is configured
    if (!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') {
      showNotification('Demo modunda ders silme Ã¶zelliÄŸi kullanÄ±lamaz. Firebase yapÄ±landÄ±rmasÄ± gerekli.', 'info');
      return;
    }

    if (window.confirm('Bu dersi silmek istediÄŸinizden emin misiniz?')) {
      try {
        const result = await scheduleService.deleteLesson(lessonId);
        if (result.success) {
          showNotification('Ders baÅŸarÄ±yla silindi.', 'success');
          loadScheduleData();
        } else {
          showNotification(result.error, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showNotification('Beklenmeyen bir hata oluÅŸtu.', 'error');
      }
    }
  };

  const showNotification = (message, type = 'info') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 5000);
  };

  const getLessonColor = (type) => {
    const colors = {
      'Pilates': 'linear-gradient(135deg, #8B5CF6 0%, #A855F7 100%)',
      'Yoga': 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
      'Reformer': 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
      'Mat Pilates': 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)',
      'Yoga Flow': 'linear-gradient(135deg, #06B6D4 0%, #0891B2 100%)',
      'Yin Yoga': 'linear-gradient(135deg, #84CC16 0%, #65A30D 100%)',
      'Vinyasa': 'linear-gradient(135deg, #F97316 0%, #EA580C 100%)',
      'Hatha Yoga': 'linear-gradient(135deg, #6366F1 0%, #4F46E5 100%)',
      'Strength Training': 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
      'Cardio': 'linear-gradient(135deg, #EC4899 0%, #DB2777 100%)',
      'Stretching': 'linear-gradient(135deg, #14B8A6 0%, #0D9488 100%)',
      'Meditation': 'linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%)'
    };
    return colors[type] || 'linear-gradient(135deg, #6B7280 0%, #4B5563 100%)';
  };

  const canEditLesson = (lesson) => {
    return currentUser?.role === 'admin' || 
           (currentUser?.role === 'instructor' && lesson.trainerId === currentUser.uid);
  };

  // New function to get ALL lessons at a specific time slot
  const getAllLessonsAtTime = (dayOfWeek, timeSlot) => {
    const dayLessons = schedule[dayOfWeek] || [];
    
    // Get the current week dates
    const currentWeekDates = getWeekDates(currentWeek);
    const dayIndex = Object.keys(daysOfWeek).indexOf(dayOfWeek);
    const currentDayDate = currentWeekDates[dayIndex];
    
    // Filter lessons to only show those for the current week
    const currentWeekLessons = dayLessons.filter(lesson => {
      // If lesson has scheduledDate, check if it matches the current week
      if (lesson.scheduledDate) {
        const lessonDate = new Date(lesson.scheduledDate);
        const currentDate = new Date(currentDayDate);
        
        // Compare dates (ignore time)
        return lessonDate.toDateString() === currentDate.toDateString();
      }
      
      // For legacy lessons without scheduledDate, show them in all weeks
      return true;
    });
    
    // Return all lessons that cover this time slot
    return currentWeekLessons.filter(lesson => {
      const lessonStart = lesson.startTime;
      const lessonEnd = lesson.endTime;
      return timeSlot >= lessonStart && timeSlot < lessonEnd;
    });
  };

  // Check if this is the first time slot where any of the lessons start
  const getLessonsStartingAtTime = (dayOfWeek, timeSlot) => {
    const allLessons = getAllLessonsAtTime(dayOfWeek, timeSlot);
    return allLessons.filter(lesson => lesson.startTime === timeSlot);
  };

  const calculateLessonHeight = (lesson) => {
    if (!lesson.startTime || !lesson.endTime) return 1;
    const [startHour, startMin] = lesson.startTime.split(':').map(Number);
    const [endHour, endMin] = lesson.endTime.split(':').map(Number);
    const startMinutes = startHour * 60 + startMin;
    const endMinutes = endHour * 60 + endMin;
    const durationMinutes = endMinutes - startMinutes;
    return Math.max(1, Math.ceil(durationMinutes / 30));
  };

  const navigateWeek = (direction) => {
    const newWeek = new Date(currentWeek);
    newWeek.setDate(newWeek.getDate() + (direction * 7));
    setCurrentWeek(newWeek);
  };

  const formatWeekRange = () => {
    const start = weekDates[0];
    const end = weekDates[6];
    const startStr = `${start.getDate().toString().padStart(2, '0')}/${(start.getMonth() + 1).toString().padStart(2, '0')}`;
    const endStr = `${end.getDate().toString().padStart(2, '0')}/${(end.getMonth() + 1).toString().padStart(2, '0')}`;
    return `${startStr} - ${endStr} ${start.getFullYear()}`;
  };

  if (loading) {
    return (
      <div className="schedule">
        <div className="loading-container">
          <div className="loading-header">
            <div className="loading-logo">
              <div className="pulse-circle"></div>
              <h2>Zenith Studio</h2>
            </div>
            <div className="loading-progress">
              <div className="progress-bar">
                <div className="progress-fill"></div>
              </div>
              <p>Program yÃ¼kleniyor...</p>
            </div>
          </div>
          
          <div className="schedule-skeleton">
            <div className="skeleton-header">
              <div className="skeleton-nav">
                <div className="skeleton-button"></div>
                <div className="skeleton-title"></div>
                <div className="skeleton-button"></div>
              </div>
            </div>
            
            <div className="skeleton-calendar">
              <div className="skeleton-time-column">
                {Array(12).fill(0).map((_, i) => (
                  <div key={i} className="skeleton-time-slot"></div>
                ))}
              </div>
              
              {Array(7).fill(0).map((_, dayIndex) => (
                <div key={dayIndex} className="skeleton-day-column">
                  <div className="skeleton-day-header"></div>
                  {Array(12).fill(0).map((_, timeIndex) => (
                    <div key={timeIndex} className="skeleton-time-cell">
                      {Math.random() > 0.7 && (
                        <div className="skeleton-lesson"></div>
                      )}
                    </div>
                  ))}
                </div>
              ))}
            </div>
            
            <div className="loading-tips">
              <div className="tip-animation">
                <div className="tip-icon">ğŸ’¡</div>
                <div className="tip-text">
                  <span>Ä°pucu: Takvimde boÅŸ bir alana tÄ±klayarak hÄ±zlÄ±ca ders ekleyebilirsiniz</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="schedule">
      {/* Demo Mode Banner */}
      {(!import.meta.env.VITE_FIREBASE_PROJECT_ID || import.meta.env.VITE_FIREBASE_PROJECT_ID === 'placeholder-project') && (
        <div className="demo-banner">
          <div className="demo-content">
            <span className="demo-icon">ğŸš€</span>
            <div className="demo-text">
              <strong>Demo Modu</strong>
              <p>Firebase yapÄ±landÄ±rmasÄ± yapÄ±lmamÄ±ÅŸ. Ã–rnek veriler gÃ¶steriliyor.</p>
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <div className="schedule-header">
        <div className="schedule-title-section">
          <h1>Ders ProgramÄ±</h1>
          <p>HaftalÄ±k ders programÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin</p>
        </div>
        
        <div className="schedule-actions">
          <button 
            className="btn btn-primary" 
            onClick={handleOpenRecurringModal}
            style={{ marginRight: '12px' }}
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            SÄ±nÄ±f Ekle
          </button>
          <button className="btn btn-secondary" onClick={loadScheduleData}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Yenile
          </button>
        </div>
      </div>

      {/* Quick Stats */}
      <div className="stats-grid">
        <div className="stat-card">
          <div className="stat-header">
            <div className="stat-icon" style={{ background: 'var(--sage-green)', color: 'white' }}>
              ğŸ“…
            </div>
            <div className="stat-trend up">+12%</div>
          </div>
          <div className="stat-value">
            {Object.values(schedule).reduce((total, dayLessons) => total + dayLessons.length, 0)}
          </div>
          <div className="stat-title">Bu Hafta Toplam Ders</div>
          <div className="stat-change">GeÃ§en haftaya gÃ¶re artÄ±ÅŸ</div>
        </div>
        
        <div className="stat-card">
          <div className="stat-header">
            <div className="stat-icon" style={{ background: 'var(--accent-mint)', color: 'var(--sage-dark)' }}>
              ğŸ‘¥
            </div>
            <div className="stat-trend up">+8%</div>
          </div>
          <div className="stat-value">
            {Object.values(schedule).reduce((total, dayLessons) => 
              total + dayLessons.reduce((dayTotal, lesson) => dayTotal + (lesson.maxParticipants || 0), 0), 0
            )}
          </div>
          <div className="stat-title">Toplam Kapasite</div>
          <div className="stat-change">HaftalÄ±k kapasite</div>
        </div>
        
        <div className="stat-card">
          <div className="stat-header">
            <div className="stat-icon" style={{ background: 'var(--accent-terra)', color: 'white' }}>
              ğŸƒâ€â™€ï¸
            </div>
            <div className="stat-trend up">+5%</div>
          </div>
          <div className="stat-value">{trainers.length}</div>
          <div className="stat-title">Aktif EÄŸitmen</div>
          <div className="stat-change">Program dahilinde</div>
        </div>
        
        <div className="stat-card">
          <div className="stat-header">
            <div className="stat-icon" style={{ background: 'var(--accent-rose)', color: 'white' }}>
              â­
            </div>
            <div className="stat-trend up">+15%</div>
          </div>
          <div className="stat-value">
            {new Set(Object.values(schedule).flat().map(lesson => lesson.type)).size}
          </div>
          <div className="stat-title">FarklÄ± Ders TÃ¼rÃ¼</div>
          <div className="stat-change">Ã‡eÅŸitlilik artÄ±ÅŸÄ±</div>
        </div>
      </div>

      {/* Week Navigation */}
      <div className="week-navigation">
        <button className="nav-button" onClick={() => navigateWeek(-1)}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="15,18 9,12 15,6"/>
          </svg>
        </button>
        
        <div className="week-info">
          <h2>{formatWeekRange()}</h2>
          <button 
            className="today-button"
            onClick={() => setCurrentWeek(new Date())}
          >
            BugÃ¼n
          </button>
        </div>
        
        <button className="nav-button" onClick={() => navigateWeek(1)}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <polyline points="9,18 15,12 9,6"/>
          </svg>
        </button>
      </div>

      {/* Calendar Grid */}
      <div className="calendar-help" style={{
        background: 'var(--gray-50)',
        border: '1px solid var(--gray-200)',
        borderRadius: 'var(--radius-md)',
        padding: '12px 16px',
        marginBottom: '16px',
        fontSize: '14px',
        color: 'var(--gray-600)'
      }}>
        <span style={{ fontWeight: '600', color: 'var(--gray-700)' }}>NasÄ±l ders oluÅŸturulur:</span>
        <br />
        â€¢ <strong>"SÄ±nÄ±f Ekle"</strong> butonu: Tekrarlayan dersler iÃ§in (haftalÄ±k program)
        <br />
        â€¢ <strong>BoÅŸ saat dilimini tÄ±klayÄ±n:</strong> O saatte yeni bir ders oluÅŸturmak iÃ§in
        <br />
        â€¢ <strong>AynÄ± saatte birden fazla ders:</strong> Yan yana gÃ¶rÃ¼ntÃ¼lenir, sayÄ± ile iÅŸaretlenir
      </div>
      <div className="calendar-container">
        <div className="calendar-grid">
          {/* Header with days */}
          <div className="calendar-header">
            <div className="time-header">Saat</div>
            {Object.entries(daysOfWeek).map(([day, label], index) => {
              const date = weekDates[index];
              const isToday = new Date().toDateString() === date.toDateString();
              return (
                <div key={day} className={`day-header ${isToday ? 'today' : ''}`}>
                  <div className="day-label">{label}</div>
                  <div className="day-date">
                    {date.getDate().toString().padStart(2, '0')}/{(date.getMonth() + 1).toString().padStart(2, '0')}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Time slots and lessons */}
          <div className="calendar-body">
            {timeSlots.map((timeSlot) => (
              <div key={timeSlot} className="time-row">
                <div className="time-label">
                  {timeSlot}
                </div>
                {Object.keys(daysOfWeek).map((day) => {
                  const allLessons = getAllLessonsAtTime(day, timeSlot);
                  const lessonsStartingHere = getLessonsStartingAtTime(day, timeSlot);
                  const hasAnyLesson = allLessons.length > 0;
                  
                  return (
                    <div 
                      key={`${day}-${timeSlot}`} 
                      className="time-cell"
                      onClick={() => !hasAnyLesson && handleCreateLesson(day, timeSlot)}
                    >
                      {lessonsStartingHere.length > 0 && (
                        <div className="lessons-container">
                          {lessonsStartingHere.map((lesson, index) => (
                            <div 
                              key={lesson.id}
                              className={`lesson-block ${lessonsStartingHere.length > 1 ? 'multiple-lessons' : ''}`}
                              style={{ 
                                background: getLessonColor(lesson.type),
                                height: `${calculateLessonHeight(lesson) * 60 - 6}px`,
                                width: lessonsStartingHere.length > 1 
                                  ? `calc(${100 / lessonsStartingHere.length}% - ${4 * (lessonsStartingHere.length - 1) / lessonsStartingHere.length}px)`
                                  : 'calc(100% - 12px)',
                                left: lessonsStartingHere.length > 1 
                                  ? `calc(${(index * 100) / lessonsStartingHere.length}% + ${index * 2}px)`
                                  : '6px',
                                right: lessonsStartingHere.length === 1 ? '6px' : 'auto',
                                zIndex: 10 + index
                              }}
                              onClick={(e) => {
                                e.stopPropagation();
                                if (canEditLesson(lesson)) {
                                  handleEditLesson(lesson);
                                }
                              }}
                            >
                              {/* Lesson counter for multiple lessons */}
                              {lessonsStartingHere.length > 1 && index === 0 && (
                                <div className="lesson-counter">
                                  {lessonsStartingHere.length}
                                </div>
                              )}
                              <div className="lesson-content">
                                <div className="lesson-title" title={lesson.title}>
                                  {lessonsStartingHere.length > 1 && lesson.title.length > 8 
                                    ? lesson.title.substring(0, 8) + '...' 
                                    : lesson.title}
                                </div>
                                {lessonsStartingHere.length === 1 && (
                                  <div className="lesson-info">
                                    <span className="lesson-participants">
                                      ğŸ‘¥ 0/{lesson.maxParticipants}
                                    </span>
                                    <span className="lesson-trainer">
                                      ğŸ‘¨â€ğŸ« {lesson.trainerName?.split(' ')[0]}
                                    </span>
                                  </div>
                                )}
                                {lessonsStartingHere.length > 1 && (
                                  <div className="lesson-info-compact">
                                    <span className="lesson-time">
                                      {lesson.startTime}
                                    </span>
                                    <span className="lesson-participants-compact">
                                      ğŸ‘¥ {lesson.maxParticipants}
                                    </span>
                                  </div>
                                )}
                              </div>
                              {canEditLesson(lesson) && lessonsStartingHere.length === 1 && (
                                <div className="lesson-actions">
                                  <button 
                                    className="action-button edit"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleEditLesson(lesson);
                                    }}
                                  >
                                    âœï¸
                                  </button>
                                  <button 
                                    className="action-button delete"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleDeleteLesson(lesson.id);
                                    }}
                                  >
                                    ğŸ—‘ï¸
                                  </button>
                                </div>
                              )}
                              {canEditLesson(lesson) && lessonsStartingHere.length > 1 && (
                                <div className="lesson-actions-compact">
                                  <button 
                                    className="action-button-compact edit"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleEditLesson(lesson);
                                    }}
                                    title="DÃ¼zenle"
                                  >
                                    âœï¸
                                  </button>
                                  <button 
                                    className="action-button-compact delete"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleDeleteLesson(lesson.id);
                                    }}
                                    title="Sil"
                                  >
                                    ğŸ—‘ï¸
                                  </button>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Create/Edit Lesson Modal */}
      {showCreateModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="modal-header">
              <h2>{editingLesson ? 'Ders DÃ¼zenle' : 'Ders OluÅŸtur'}</h2>
              <button 
                className="modal-close"
                onClick={() => setShowCreateModal(false)}
              >
                Ã—
              </button>
            </div>
            
            <div className="modal-form">
              <div className="form-row">
                <div className="form-group">
                  <label>Ders AdÄ± *</label>
                  <input
                    type="text"
                    value={lessonForm.title}
                    onChange={(e) => handleFormChange('title', e.target.value)}
                    placeholder="Ders adÄ±nÄ± girin"
                  />
                </div>
                
                <div className="form-group">
                  <label>Ders TÃ¼rÃ¼ *</label>
                  <select
                    value={lessonForm.type}
                    onChange={(e) => handleFormChange('type', e.target.value)}
                  >
                    <option value="">SeÃ§in</option>
                    {lessonTypes.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>EÄŸitmen *</label>
                  <select
                    value={lessonForm.trainerId}
                    onChange={(e) => handleFormChange('trainerId', e.target.value)}
                    disabled={currentUser?.role === 'instructor'}
                  >
                    <option value="">SeÃ§in</option>
                    {trainers.map(trainer => (
                      <option key={trainer.id} value={trainer.id}>
                        {trainer.displayName}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>GÃ¼n *</label>
                  <select
                    value={lessonForm.dayOfWeek}
                    onChange={(e) => handleFormChange('dayOfWeek', e.target.value)}
                  >
                    {Object.entries(daysOfWeek).map(([day, label]) => (
                      <option key={day} value={day}>{label}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>BaÅŸlangÄ±Ã§ Saati *</label>
                  <select
                    value={lessonForm.startTime}
                    onChange={(e) => handleFormChange('startTime', e.target.value)}
                  >
                    <option value="">--:--</option>
                    {timeSlots.map(time => (
                      <option key={time} value={time}>{time}</option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>SÃ¼re (dakika) *</label>
                  <select
                    value={lessonForm.duration}
                    onChange={(e) => handleFormChange('duration', parseInt(e.target.value))}
                  >
                    <option value={45}>45 dakika</option>
                    <option value={60}>60 dakika</option>
                    <option value={75}>75 dakika</option>
                    <option value={90}>90 dakika</option>
                  </select>
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>BitiÅŸ Saati (Otomatik)</label>
                  <input
                    type="time"
                    value={lessonForm.endTime}
                    readOnly
                    className="readonly-input"
                    title="BitiÅŸ saati baÅŸlangÄ±Ã§ saati ve sÃ¼reye gÃ¶re otomatik hesaplanÄ±r"
                  />
                </div>
                
              <div className="form-row">
                <div className="form-group">
                  <label>Maksimum KatÄ±lÄ±mcÄ±</label>
                  <input
                    type="number"
                    value={lessonForm.maxParticipants}
                    onChange={(e) => handleFormChange('maxParticipants', parseInt(e.target.value))}
                    min="1"
                    max="50"
                  />
                </div>
                
                <div className="form-group">
                  <label>Mevcut KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label>
                  <input
                    type="number"
                    value={lessonForm.currentParticipants}
                    onChange={(e) => handleFormChange('currentParticipants', parseInt(e.target.value))}
                    min="0"
                    max={lessonForm.maxParticipants || 50}
                  />
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Seviye</label>
                  <select
                    value={lessonForm.level}
                    onChange={(e) => handleFormChange('level', e.target.value)}
                  >
                    {Object.entries(levels).map(([level, label]) => (
                      <option key={level} value={level}>{label}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>AÃ§Ä±klama</label>
                <textarea
                  value={lessonForm.description}
                  onChange={(e) => handleFormChange('description', e.target.value)}
                  placeholder="Ders hakkÄ±nda detaylar..."
                  rows="3"
                />
              </div>

              <div className="modal-actions">
                <button 
                  className="btn btn-secondary"
                  onClick={() => setShowCreateModal(false)}
                >
                  Ä°ptal
                </button>
                <button 
                  className="btn btn-primary"
                  onClick={handleSaveLesson}
                >
                  {editingLesson ? 'GÃ¼ncelle' : 'OluÅŸtur'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Recurring Lesson Modal */}
      {showRecurringModal && (
        <div className="modal-overlay">
          <div className="modal-content" style={{ maxWidth: '600px' }}>
            <div className="modal-header">
              <h2>SÄ±nÄ±f Ekle - Tekrarlanan Program</h2>
              <button 
                className="modal-close"
                onClick={() => setShowRecurringModal(false)}
              >
                Ã—
              </button>
            </div>
            
            <div className="modal-form">
              <div className="form-row">
                <div className="form-group">
                  <label>SÄ±nÄ±f AdÄ± *</label>
                  <input
                    type="text"
                    value={recurringForm.title}
                    onChange={(e) => handleRecurringFormChange('title', e.target.value)}
                    placeholder="SÄ±nÄ±f adÄ±nÄ± girin"
                  />
                </div>
                
                <div className="form-group">
                  <label>SÄ±nÄ±f TÃ¼rÃ¼ *</label>
                  <select
                    value={recurringForm.type}
                    onChange={(e) => handleRecurringFormChange('type', e.target.value)}
                  >
                    <option value="">TÃ¼r seÃ§in</option>
                    {lessonTypes.map(type => (
                      <option key={type} value={type}>{type}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>EÄŸitmen *</label>
                <select
                  value={recurringForm.trainerId}
                  onChange={(e) => handleRecurringFormChange('trainerId', e.target.value)}
                  disabled={currentUser?.role === 'instructor'}
                >
                  <option value="">EÄŸitmen seÃ§in</option>
                  {trainers.map(trainer => (
                    <option key={trainer.id} value={trainer.id}>
                      {trainer.displayName}
                    </option>
                  ))}
                </select>
              </div>

              <div className="recurring-section">
                <h3>GÃ¼nleri SeÃ§in</h3>
                <div className="days-selection">
                  {Object.entries(daysOfWeek).map(([day, label]) => (
                    <label key={day} className="day-checkbox">
                      <input
                        type="checkbox"
                        checked={recurringForm.selectedDays.includes(day)}
                        onChange={() => handleDayToggle(day)}
                      />
                      <span className="day-label">{label}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>BaÅŸlangÄ±Ã§ Saati *</label>
                  <select
                    value={recurringForm.startTime}
                    onChange={(e) => handleRecurringFormChange('startTime', e.target.value)}
                  >
                    <option value="">--:--</option>
                    {timeSlots.map(time => (
                      <option key={time} value={time}>{time}</option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>SÃ¼re (dakika) *</label>
                  <select
                    value={recurringForm.duration}
                    onChange={(e) => handleRecurringFormChange('duration', parseInt(e.target.value))}
                  >
                    <option value={30}>30 dakika</option>
                    <option value={45}>45 dakika</option>
                    <option value={60}>60 dakika</option>
                    <option value={75}>75 dakika</option>
                    <option value={90}>90 dakika</option>
                    <option value={120}>120 dakika</option>
                  </select>
                </div>
              </div>

              <div className="form-group">
                <label>BitiÅŸ Saati</label>
                <input
                  type="time"
                  value={recurringForm.endTime}
                  readOnly
                  style={{ 
                    backgroundColor: 'var(--gray-100)',
                    cursor: 'not-allowed',
                    color: 'var(--gray-600)'
                  }}
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Maksimum KatÄ±lÄ±mcÄ±</label>
                  <input
                    type="number"
                    value={recurringForm.maxParticipants}
                    onChange={(e) => handleRecurringFormChange('maxParticipants', parseInt(e.target.value))}
                    min="1"
                    max="50"
                  />
                </div>
                
                <div className="form-group">
                  <label>BaÅŸlangÄ±Ã§ KatÄ±lÄ±mcÄ± SayÄ±sÄ±</label>
                  <input
                    type="number"
                    value={recurringForm.currentParticipants}
                    onChange={(e) => handleRecurringFormChange('currentParticipants', parseInt(e.target.value))}
                    min="0"
                    max={recurringForm.maxParticipants || 50}
                  />
                </div>
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Seviye</label>
                  <select
                    value={recurringForm.level}
                    onChange={(e) => handleRecurringFormChange('level', e.target.value)}
                  >
                    {Object.entries(levels).map(([level, label]) => (
                      <option key={level} value={level}>{label}</option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  {/* Empty space for better layout */}
                </div>
              </div>

              <div className="form-group">
                <label>AÃ§Ä±klama</label>
                <textarea
                  value={recurringForm.description}
                  onChange={(e) => handleRecurringFormChange('description', e.target.value)}
                  placeholder="SÄ±nÄ±f aÃ§Ä±klamasÄ±..."
                  rows="3"
                />
              </div>

              <div style={{ 
                border: '1px solid var(--gray-300)', 
                borderRadius: '8px', 
                padding: '16px', 
                marginTop: '16px',
                backgroundColor: 'var(--gray-50)'
              }}>
                <h4 style={{ margin: '0 0 16px 0', color: 'var(--gray-700)' }}>Program AyarlarÄ±</h4>
                
                <div className="form-row">
                  <div className="form-group">
                    <label>BaÅŸlangÄ±Ã§ Tarihi *</label>
                    <select
                      value={recurringForm.startDate}
                      onChange={(e) => handleRecurringFormChange('startDate', e.target.value)}
                    >
                      <option value="">Tarih seÃ§in</option>
                      {dateOptions.map(date => (
                        <option key={date.value} value={date.value}>
                          {date.label}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label>BitiÅŸ Tarihi</label>
                    <input
                      type="date"
                      value={recurringForm.endDate}
                      readOnly
                      style={{ 
                        backgroundColor: 'var(--gray-100)',
                        cursor: 'not-allowed',
                        color: 'var(--gray-600)'
                      }}
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>KaÃ§ Hafta Tekrarlanacak *</label>
                  <select
                    value={recurringForm.repeatWeeks}
                    onChange={(e) => handleRecurringFormChange('repeatWeeks', parseInt(e.target.value))}
                  >
                    <option value={1}>1 hafta</option>
                    <option value={2}>2 hafta</option>
                    <option value={4}>4 hafta</option>
                    <option value={8}>8 hafta</option>
                    <option value={12}>12 hafta</option>
                    <option value={16}>16 hafta</option>
                    <option value={24}>24 hafta</option>
                    <option value={52}>52 hafta (1 yÄ±l)</option>
                  </select>
                </div>

                <div className="form-info">
                  <p style={{ margin: '0', fontSize: '14px', color: 'var(--gray-600)' }}>
                    SeÃ§ilen gÃ¼nlerde {recurringForm.repeatWeeks} hafta boyunca tekrarlanan dersler oluÅŸturulacak. 
                    Toplam {recurringForm.selectedDays.length} gÃ¼n Ã— {recurringForm.repeatWeeks} hafta = {recurringForm.selectedDays.length * recurringForm.repeatWeeks} ders.
                    Her ders baÄŸÄ±msÄ±z olarak dÃ¼zenlenebilir veya silinebilir.
                  </p>
                </div>
              </div>

              <div className="modal-actions" style={{ marginTop: '24px' }}>
                <button 
                  className="btn btn-secondary"
                  onClick={() => setShowRecurringModal(false)}
                >
                  Ä°ptal
                </button>
                <button 
                  className="btn btn-primary"
                  onClick={handleSaveRecurringLessons}
                >
                  SÄ±nÄ±flarÄ± OluÅŸtur
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Notification */}
      {notification && (
        <div className={`notification ${notification.type}`} style={{
          position: 'fixed',
          top: '20px',
          right: '20px',
          padding: '16px 20px',
          borderRadius: '12px',
          background: notification.type === 'success' ? '#D1FAE5' : '#FEE2E2',
          color: notification.type === 'success' ? '#065F46' : '#DC2626',
          boxShadow: '0 10px 25px rgba(0, 0, 0, 0.1)',
          zIndex: 1000,
          maxWidth: '400px'
        }}>
          {notification.message}
          <button 
            onClick={() => setNotification(null)}
            style={{
              position: 'absolute',
              top: '8px',
              right: '8px',
              background: 'none',
              border: 'none',
              fontSize: '18px',
              cursor: 'pointer',
              color: 'inherit'
            }}
          >
            Ã—
          </button>
        </div>
      )}
    </div>
  );
};

export default Schedule;